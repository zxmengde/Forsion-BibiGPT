---
description: "代码修改后自动调用 Chrome DevTools 验证功能完整性"
alwaysApply: true
---

# 自动化功能验证规则

每当你完成了代码修改（无论是新功能添加还是 bug 修复），你必须 **自动** 执行以下 Chrome DevTools 验证流程，不需要用户额外要求。

---

## 触发条件

当你在本次对话中对项目文件（`.tsx`、`.ts`、`.css`、`.js` 等）进行了任何代码编辑后，在回复用户之前，必须执行下方的验证流程。

---

## 验证流程

### 第一步：检查开发服务器

1. 读取 terminals 目录，确认是否有终端正在运行 `npm run dev`。
2. 如果开发服务器未运行，先在后台终端执行 `npm run dev` 启动开发服务器，并等待编译完成。

### 第二步：导航到页面

1. 使用 `list_pages` 查看当前浏览器中是否已有 `localhost:2014` 的标签页。
2. 如果有，使用 `select_page` 选中该标签页，然后 `navigate_page` 刷新页面（type: reload）。
3. 如果没有，使用 `navigate_page` 导航到 `http://localhost:2014`。
4. 使用 `wait_for` 等待页面关键元素加载完成（例如等待文本 "BibiGPT" 或页面主要标识出现）。

### 第三步：检查控制台错误

1. 使用 `list_console_messages`，过滤 `types: ["error", "warn"]`，检查是否存在异常。
2. 如果发现 **error** 级别的错误消息：
   - 使用 `get_console_message` 获取详细信息。
   - 在验证报告中标注这些错误。
   - 如果错误与本次修改相关，尝试修复后重新验证。
3. 对于 warn 级别的消息，记录但不阻断流程。

### 第四步：获取页面快照

1. 使用 `take_snapshot` 获取页面的 a11y 树快照。
2. 根据本次修改的内容，检查相关 UI 元素是否存在且正确：
   - 新增的按钮、文本、输入框等是否出现在快照中。
   - 关键组件（导航栏、输入框、按钮等）是否正常渲染。

### 第五步：功能交互验证

根据本次修改涉及的功能，执行针对性的交互测试：

- **如果修改了输入相关功能**：使用 `fill` 在输入框中输入测试 URL，验证输入是否正常。
- **如果修改了按钮/交互功能**：使用 `click` 点击相关按钮，观察响应是否正确。
- **如果修改了弹窗/对话框**：触发弹窗后使用 `take_snapshot` 验证弹窗内容。
- **如果修改了 API 相关功能**：使用 `list_network_requests` 检查 API 调用是否正常发出。
- **如果修改了样式/布局**：使用 `take_screenshot` 截图检查视觉效果。

### 第六步：截图存档

1. 使用 `take_screenshot` 对当前页面截图。
2. 如果修改涉及特定区域，对该区域元素单独截图（通过 uid 参数）。

### 第七步：网络请求检查（如涉及 API 修改）

1. 使用 `list_network_requests` 查看页面的网络请求。
2. 检查是否有失败的请求（状态码 4xx/5xx）。
3. 如果涉及 API 修改，使用 `get_network_request` 检查请求/响应内容是否正确。

### 第八步：输出验证报告

完成验证后，在回复中输出验证报告，格式如下：

```
## ✅ 功能验证报告

**验证时间**：YYYY-MM-DD HH:MM
**修改类型**：新功能 / Bug修复 / 优化
**修改描述**：[简要描述本次修改内容]

### 验证结果

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 页面加载 | ✅/❌ | 页面是否正常加载 |
| 控制台错误 | ✅/❌ | 是否有新增错误 |
| UI 渲染 | ✅/❌ | 相关组件是否正确渲染 |
| 功能交互 | ✅/❌ | 交互功能是否正常工作 |
| 网络请求 | ✅/❌ | API 请求是否正常 |
| 视觉检查 | ✅/❌ | 页面外观是否正常 |

### 详细说明
[如有问题或需要注意的事项，在这里详细说明]
```

---

## 变更日志更新

- 如果本次修改是 **新功能添加**，在验证通过后，自动将功能描述添加到 `docs/change.md` 文档中，遵循已有的格式。
- 如果本次修改是 **Bug 修复**，不需要更新 `docs/change.md`。

---

## 特殊场景处理

### 页面路由验证

如果修改涉及特定路由的页面（如 `/user/preferences`、`/shop` 等），需要导航到对应路由进行验证。

### 响应式验证

如果修改涉及响应式布局，使用 `emulate` 工具测试不同视口尺寸：
- 桌面端：1920x1080
- 平板端：768x1024
- 移动端：375x667

### 多步骤功能验证

如果功能涉及多步骤操作（如：输入URL → 点击总结 → 等待结果），按顺序执行每个步骤并在关键节点截图验证。

---

## 注意事项

1. 验证过程中如果发现与本次修改相关的问题，应先尝试修复，然后重新执行验证流程。
2. 验证过程中发现的与本次修改无关的已有问题，在报告中记录但不做处理。
3. 如果页面加载失败或开发服务器异常，先排查并解决服务器问题。
4. 每次验证都应获取最新的页面快照，不要依赖之前的缓存数据。
5. 本项目运行端口为 **2014**，开发服务器地址为 `http://localhost:2014`。
